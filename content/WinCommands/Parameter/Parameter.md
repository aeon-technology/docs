# PARAMETERS MENU - FIT AND VALIDATE FORCEFIELD PARAMETERS

## FIT QM DATA 
To use the following parameter fitting functions, QMD files should first be loaded and associated with corresponding MSD files. Note that all forcefield related operations, such as assigning atom types, charges, etc., are performed on the MSD files. Make sure the forcefield is associated with appropriate MSD files. 

**Fit Charge Data** is used to fit charge parameters from QM atomic charges. It opens the Make Charge Parameters dialog. Data source indicates what data is used for deriving charge parameters. Scaling factor scales the data. Available models lists selected models. Reset reloads the available models, and Remove removes models from the list. Show comparison of charges displays fit results with original data. Parameter model fits charges based on atom types (Atom type based) or bond increment parameters (Bond type based). Execute starts the fitting procedure. 

**Fit Energy Data** is used to fit valence parameters from QM data via a dialog with three tabbed panels. Prior to using Fit Energy Data, charge parameters should be prepared and atom charges should be assigned.

In the first panel, Job & Data, Data to fit lists QMD models to be used. Reset and Remove can be used to modify data models to fit. Weighting factors are applied to Energy, Gradient and Hessian respectively. The default values are 100, 10 and 1. Apply Boltzmann Factor applies only to energy. FF Type is determined by the associated forcefield to be parameterized. Job Name assigns a name to background jobs. The input forcefield should be entered into Initial FF. The fit result will be written into Result FF. The job, initial forcefield, and result forcefield names are numbered sequentially; with each iterative fit, the suffix number increases by one, and previous result forcefield becomes the new initial forcefield. Thus, the fit may be repeated multiple times. If a new fit needs to be started, click Start Over to reset the job sequence. By default, the initial forcefield is the forcefield associated with the QMD files to be fit, which is listed in the Forcefield text field in the toolbar and can also be viewed by clicking View Forcefield.  

The second panel, Procedure, provides options to set fitting procedure and relevant parameters. Auto Procedure, which uses DFF expert system to fit the data, is selected by default. To disable automatic fitting, select either Levenberg-Marquardt or SVD. Note the SVD method only fits linear terms. For the Levenberg-Marquardt method, the Maximum iteration number and the Convergence threshold can be specified. For the SVD method, the Filter threshold, which controls redundancy in the parameter space, can be adjusted.

The third panel, Parameters, allows the user to set adjustable parameters used during the fitting procedure. Constraints contains options used to place constraints on the parameters, which are useful especially when data is inadequate for deriving parameters. Auto-reduce coupling terms reduces redundant torsion terms in a forcefield. Freeze nonbonded terms is the default for fitting intramolecular properties. Freeze out-of-plane terms reduces adjustable parameters which may be redundantly used in a forcefield. Use wildcards in torsion terms is another way to reduce the number of adjustable parameters in the torsion terms. 
Three options are available for the Torsional terms: Default, Maximum, and Minimum. The Default option allows the system to automatically decide the number of torsion parameters depending on the number of data points. The Anharmonic terms can be Frozen to zeros, Relaxed, or Derived. The Derived option, anharmonic parameters are derived (not fitted) from harmonic force constants.  A Penalty factor is used by the implemented conditional minimizer to control parameters related to bond lengths and angles. If the Check and fix parameter option in the Parameter correction section is selected, parameters will be checked against two criteria: estimated variance and specified range. If the test fails, the corresponding parameter will be fixed. On the right side, Additional Energy Terms may be added by clicking on corresponding terms. Note that the terms available are related to the forcefield type selected.

**Fit VDW Dimer** derives VDW parameters by fitting QM data for molecular dimers. The data requirement for this function is slightly different from that for fitting molecular conformers. The QM data must be prepared for the dimer and for all monomers. For dimers, monomers configurations in different separations should be included in addition to optimized structures. This function only uses energies. Relationships between loaded models must be specified before fitting. To use this command, select the QM models, associate an initial forcefield, relax at least one of the LJ parameters, and open the Fit Cluster Configuration dialog.

This dialog contains two tabbed panels. The Job&Data tab has two parts. On the left side, Data to fit lists selected models. Select the dimer model and click Cluster. Then select the monomer models and click Monomer. If the cluster contains only one monomer type, repeat the operation twice. A number after an asterisk (*) will tell you how many times the monomer used. Reset clears previous settings, and¬ Remove clears any models that are not required. The right side is very similar to that used in the Fit Energy Data dialog, and the Procedure panel is the same as that used in the Fit Energy Data dialog. 

## FIT LIQUID PROPERTIES 

Fit Liquid Properties fits VDW parameters fields from liquid data. A liquid model is required instead of a single molecule. Use the Build → Liquid Bulk command to build a liquid box and ensure it has correct valence parameters. Then relax some nonbond parameters in the forcefield editor. During the fitting of valence parameters, nonbond parameters are normally fixed. Then click Fit Liquid Properties to open a Fit Liquid Data dialog. Name, Input FF and Output FF are used to identify files used in the background job. Run NVT generates the reference state using MD simulation. If you want to use a saved trajectory file from a previous simulation instead, click Use saved trajectory. If Run NVT is selected, enter a target temperature and click Opt. to examine and modify simulation conditions. If using a saved trajectory, use Browse to find the trajectory file. In the Data to fit section, select liquid data to fit into Pressure(MPa) and Hv(kcal/mol). The temperature and pressure should correspond to the condition at which the density and heat of vaporization are to be measured.
Since only two observable data forms are used to optimize VDW parameters, the number of adjustable variables can be reduced either by freezing some VDW parameters (for example, freezing some parameters to previously optimized parameters) or by using two scaling factors (for Lennard-Johns well depth and radii, respectively). To use the latter method, select Optimize scaling factor. Execute starts the job.

## FIT MOLECULAR PROPERTIES
Fit Structures fits molecular structural data, equilibrium bond lengths and angles. This command mimics an empirical fit in which force constants are frozen and structures are reproduced by adjusting the most sensitive parameters. This method uses a finite differentiation method to calculate the derivatives of structural properties with respect to adjustable parameters and fits structural properties using a least squares method. In order to use this command, parameters for bonds and angles must first be relaxed. This command opens the following Fit Structure Data dialog:
 
In the dialog, Job Name, Input ppf File, Forcefield type and Output ppf File are used to identify files for the background job. QM data lists selected QM model. Options are maximum iteration and step size which controls how the fit is performed. In the Parameters panel is used to set adjustable parameters. In this panel, Fix force constants, Fix out-of-plane terms, and Auto-reduce parameters are useful to reduce the adjustable parameters. For the Auto-reduce parameters option, the Structural deviation threshold is used to eliminate the adjustable parameters for bond lengths and angles with deviations lower than the threshold. 

Fit Torsion Energies fits minimized torsional energy profiles only. This command uses numerical differentiation to calculate derivatives of the minimized torsional energy profile with respect to the adjustable parameters, and then uses the derivatives in a least squares fit. Job Name, Input ppf File, Forcefield type and Output ppf File are used to select files for the background job. QM data displays the selected QMD file, which must contain the minimized conformational energy data.
 
There are three tabbed panels. Restraints lists the scanned torsion angle, identified by atom names, force constant, starting value, interval, and data point. Excepting the force constant, which is set to a default of 500, these values are taken from the QMD file and are consistent with QM calculations.  MM Options are parameters for constrained energy minimization. Fit Options specify differentiation step size and fit maximum iteration, and includes an option to reduce the coupling torsional parameters.

## ADDITIONAL TOOLS

**Analyze Fit** opens a Fit Analysis dialog used to view the .dft file, which records fit results. The Fit Analysis dialog contains two tabbed panels. The first, Fit Merits (i/o) shows deviations between input and fitted energies, gradients, and Hessian matrix elements. The second, Optimized Results (i/o), displays comparisons between optimized structures and vibrational frequencies. The result forcefield is used to minimize molecules and compare results against input data for optimized structures. Two components are displayed in each of the panels. On the left, a table lists standard deviations; on the right, the correlation of input to fitted data is displayed graphically. Clicking column headers will display corresponding correlation charts for each property. Clicking any cell in the table will display the property correlation chart for that specific model. When input and fitted data agree well, all data points should be located on the diagonal line of the correlation chart. Clicking on Data opens another window to display the data numerically. It also displays the difference between the Input and Fit results. From this window, the data can be saved as a comma delimited (.csv) file for export to other spreadsheet applications such as Microsoft Excel.

**Estimate Charge** applies the QEq method to estimate charge parameters for selected models. To use this command, a forcefield must first be created and associated with the models. After selecting the models from the Project Navigator and clicking Estimate Charge, a dialog shows the input and output PPF files. After execution, the output PPF file will populate with estimated charge parameters, and partial charges are assigned to models.

**Estimate Parameters** opens an Estimate Forcefield dialog to estimate valence and nonbond parameters for a given molecule. In this dialog, you may select the models you want to use to estimate the parameters in the Model panel and assign output forcefield names. If Save active parameters only is checked, the output forcefield will not contain any parameters not used by the selected models even if they exist in the input forcefield. If Protect existing parameters is checked, the input parameters will not be changed and only missing parameters will be created. Otherwise input parameters may be overwritten by estimated parameters. Check Use wildcard in torsion terms to create torsion parameters with wildcards on its end atoms. Check Use anharmonic terms to estimate anharmonic parameters.

**Base Parameters** opens a Default Atom Type Properties to modify the base parameters of atom types. Input the atom type to be modified in Default Atom Type and click Load to view the base parameters. You may change the data in the dialog and click Save to save the parameters.
